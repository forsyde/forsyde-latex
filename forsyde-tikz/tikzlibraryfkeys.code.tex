%%%%%%%%%%%%%%%
% ENVIRONMENT %
%%%%%%%%%%%%%%%
\tikzset{global scale/.style={
    scale=#1, globsc=#1,
    every node/.style={scale=#1}
  }
}


\newif\ifnolabel
\newif\ifnocolor
\pgfkeys{
  /tikz/globsc/.store in = \globScale,
  /tikz/globsc = 1,
  /tikz/nomoccolor/.is if=nocolor,
  /tikz/nomoclabel/.is if=nolabel,
  /tikz/type style/.store in = \typeStyle,
  /tikz/type style = \scriptsize\texttt,
  /tikz/label style/.store in = \labelStyle,
  /tikz/label style = \textbf,
  /tikz/function style/.store in = \funcStyle,
  /tikz/function style = \scriptsize,
  /tikz/token pos/.store in = \tokPos,
  /tikz/token pos = 0.5,
  /tikz/deviate/.store in = \pDeviate,
  /tikz/deviate = 0pt,
  /tikz/nary/.style={double distance=1pt, outer sep=.6pt},
  /tikz/alwaystrue/.is toggle,
  /tikz/alwaystrue = true,
}

\tikzset{
  primitive shape/.style ={draw,circle,inner sep=0pt, minimum size=15pt, fill=\defaultfillcolor},
  primitiven shape/.style={draw,circle,inner sep=0pt, minimum size=15pt, fill=\defaultfillcolor, double distance=1pt, outer sep=.6pt},
  leaf shape/.style      ={draw, rectangle, rounded corners=3pt, inner sep=0pt},
  leafn shape/.style     ={draw, rectangle, rounded corners=3pt, inner sep=0pt, double distance=1pt, outer sep=.6pt},
  composite shape/.style ={draw, rectangle, dashed, fill opacity=0},
  compositen shape/.style={draw, rectangle, dashed, fill opacity=0, double distance=1pt, outer sep=.6pt},
  connector/.style       ={draw, circle, fill=\defaultdrawcolor, inner sep=2pt, outer sep=0},
}

%%%%%%%% 
% KEYS %
%%%%%%%%
\pgfkeys{/forsyde keys/.is family, /forsyde keys,
  %shape & color
  hasmoc/.is toggle,
  moc/.estore in   = \fsdMoc,
  type/.estore in  = \fsdType,
  shape/.estore in = \fsdShape,
  blackbox/.style  = {moc=blackbox},
  % separation
  inner xsep/.estore in = \fsdInnerXSep,
  inner ysep/.estore in = \fsdInnerYSep,
  inner sep/.style      = {inner xsep = #1, inner ysep = #1 },
  % position
  anchor/.estore in = \fsdAnchor,
  xshift/.estore in = \fsdXShift,
  yshift/.estore in = \fsdYShift,
  at/.estore in     = \fsdAtInit,
  left of/.style  = {at={#1.east}, xshift=1cm, anchor=west},
  right of/.style = {at={#1.west}, xshift=-1cm, anchor=east},
  above of/.style = {at={#1.north}, yshift=1cm, anchor=south},
  below of/.style = {at={#1.south}, yshift=-1cm, anchor=north},
  % rotation
  rotate shape/.estore in = \fsdRotateShape,
  rotate/.estore in       = \fsdRotate,
  % ports & functions
  npl/.estore in = \fsdNPortLeft,
  npr/.estore in = \fsdNPortRight,
  nf/.estore in  = \fsdNFunctions,
  f1/.estore in  = \fsdFunA,
  f2/.estore in  = \fsdFunB,
  f3/.estore in  = \fsdFunC,
  f4/.estore in  = \fsdFunD,
  ni/.style      = {npl = #1 },
  no/.style      = {npr = #1 },
  f/.code        = {\makeFunctions{#1}},
  f/.default=$f_1$,
  % default values
  default/.style = {
    hasmoc        = false,
    moc           = none,
    type          =,
    shape         = rectangle,
    anchor        = center,
    inner ysep    = 3pt,
    inner xsep    = 5pt,
    rotate        = 0,
    rotate shape  = 0,
    xshift        = 0pt,
    yshift        = 0pt,
    at            = {0,0},
    npl=1, npr=1, nf=0, 
    f1=$ f_1 $, f2=$ f_2 $, f3=$ f_3 $, f4=$ f_4 $,
  },
  %%%%%%%%%%%%%%%%%%%%%%%%%%%
  % SHAPES OF MAIN ELEMENTS %
  %%%%%%%%%%%%%%%%%%%%%%%%%%%
  primitive/.style ={%
    shape=primitive shape
    },
  primitiven/.style={%
    shape=primitiven shape,
    },
  leaf/.style={%
    hasmoc,
    shape=leaf shape,
    },
  leafn/.style={% 
    hasmoc,
    shape=leafn shape,
    },
  composite/.style={%
    shape=composite shape
    },
  compositen/.style={%
    shape=compositen shape,
    },
  embed/.style={%
    hasmoc,
    shape=leaf shape,
    inner sep=15pt,
    },
  farmstyle/.style={%
    shape = dp shape,
    inner xsep = 15pt,
    inner ysep = 20pt,
    },
  pipestyle/.style={%
    shape = pipe shape,
    inner xsep = 15pt,
    inner ysep = 20pt,
    },
  skeleton/.style={%
    shape = generic shape,
    inner xsep = 15pt,
    inner ysep = 20pt,
    },
  transition/.code 2 args = {%
    \edef\theshape{transition shape #1#2}
    \tikzset{/forsyde keys/shape = \theshape}
    },
  transition/.default={v1}{v1},
  zipx/.style = {%
    transition={s1}{v1},
    rotate shape=180,
    type=zipx,
    },
  unzipx/.style = {%
    transition={s1}{v1},
    type=unzipx,
    },    
}


\pgfkeys{/transition patterns keys/.is family, /transition patterns keys,
  type/.estore in       = \pType,
  inner shape/.estore in= \pInnerShape,
  outer shape/.estore in= \pOuterShape,
  ni/.estore in         = \pNIn,
  no/.estore in         = \pNOut,
  nf/.estore in         = \pNFunc,
  f1/.estore in         = \pFuncA,
  f2/.estore in         = \pFuncB,
  f3/.estore in         = \pFuncC,
  f4/.estore in         = \pFuncD,
  reverse/.is toggle,
  reverse shape/.is toggle,
  default/.style = {
    type= ,
    inner shape = noinner, 
    outer shape = transition shape v1v1,
    ni=1, no=1, nf=0, 
    f1=$ f_1 $, f2=$ f_2 $, f3=$ f_3 $, f4=$ f_4 $, 
    reverse = false, 
    reverse shape=false, 
  },
}


\ExplSyntaxOn

\NewDocumentCommand{\makeFunctions}{m} {%
  \yourb_count_char:nn { ; } { #1 }  
  \pgfmathtruncatemacro{\nFunc}{\l_yourb_count_char_int + 1};
  \def\nnnnFunc{\nFunc}
  \tikzset{/forsyde\space keys/nf = \nFunc}
  \pgfmathtruncatemacro{\countFun}{0};
  \setFunctions{ #1 }
}
\int_new:N \l_yourb_count_char_int
\cs_new_protected:Npn \yourb_count_char:nn #1 #2 {
  \regex_count:nnN { #1 } { #2 } \l_yourb_count_char_int
}
\NewDocumentCommand{\setFunctions}{ >{ \SplitList { ; } } m } {
  \ProcessList { #1 } { \davs__tokens_setfun_rec:n }
}   
\cs_new_protected:Nn \davs__tokens_setfun_rec:n {
  \def\currentfunckey{/forsyde\space keys/f\countFun}
  \pgfmathtruncatemacro{\countFun}{\countFun + 1}
  \tikzset{\currentfunckey = {#1}}
}
\ExplSyntaxOff


\endinput
