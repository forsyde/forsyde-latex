%%%%%%%%%%%%%%%
% ENVIRONMENT %
%%%%%%%%%%%%%%%
\tikzset{global scale/.style={
    scale=#1, globsc=#1,
    every node/.style={scale=#1}
  }
}


\newif\ifnolabel
\newif\ifnocolor
\pgfkeys{
	/tikz/globsc/.store in = \globScale,
	/tikz/globsc = 1,
	/tikz/nomoccolor/.is if=nocolor,
	/tikz/nomoclabel/.is if=nolabel,
	/tikz/type style/.store in = \typeStyle,
	/tikz/type style = \scriptsize\texttt,
	/tikz/label style/.store in = \labelStyle,
	/tikz/label style = \textbf,
	/tikz/function style/.store in = \funcStyle,
	/tikz/function style = \scriptsize,
	/tikz/token pos/.store in = \tokPos,
	/tikz/token pos = 0.5,
	/tikz/deviate/.store in = \pDeviate,
	/tikz/deviate = 0pt,
}

%%%%%%%% 
% KEYS %
%%%%%%%%
\pgfkeys{/forsyde keys/.is family, /forsyde keys,
  %shape & color
  moc/.estore in   = \fsdMoc,
  type/.estore in  = \fsdType,
  shape/.estore in = \fsdShape,
  blackbox/.style  = {moc=blackbox},
  % separation
  inner xsep/.estore in = \fsdInnerXSep,
  inner ysep/.estore in = \fsdInnerYSep,
  inner sep/.style      = {inner xsep = #1, inner ysep = #1 },
  % position
  anchor/.estore in = \fsdAnchor,
  xshift/.estore in = \fsdXShift,
  yshift/.estore in = \fsdYShift,
  at/.estore in     = \fsdAtInit,
  left of/.style  = {at={#1.east}, xshift=1cm, anchor=west},
  right of/.style = {at={#1.west}, xshift=-1cm, anchor=east},
  above of/.style = {at={#1.north}, yshift=1cm, anchor=south},
  below of/.style = {at={#1.south}, yshift=-1cm, anchor=north},
  % rotation
  rotate shape/.estore in = \fsdRotateShape,
  rotate/.estore in       = \fsdRotate,
  reverse/.is toggle,
  % ports & functions
  npl/.estore in = \fsdNPortLeft,
  npr/.estore in = \fsdNPortRight,
  nf/.estore in  = \fsdNFunctions,
  f1/.estore in  = \fsdFunA,
  f2/.estore in  = \fsdFunB,
  f3/.estore in  = \fsdFunC,
  f4/.estore in  = \fsdFunD,
  ni/.style      = {npl = #1 },
  no/.style      = {npr = #1 },
  f/.style = {f1 = {#1}, nf = 1, },
  % default values
  default/.style = {
    moc           = none,
    type          =,
    shape         = rectangle,
    anchor        = center,
    inner ysep    = 3pt,
    inner xsep    = 5pt,
    reverse       = false, 
    rotate        = 0,
    rotate shape  = \iftoggle{/forsyde keys/reverse}{180}{0},
    xshift        = 0pt,
    yshift        = 0pt,
    at            = {0,0},
    npl=1, npr=1, nf=0, 
    f1=$ f_1 $, f2=$ f_2 $, f3=$ f_3 $, f4=$ f_4 $,
  }
}

\pgfkeys{/transition patterns keys/.is family, /transition patterns keys,
 	type/.estore in       = \pType,
 	inner shape/.estore in= \pInnerShape,
	outer shape/.estore in= \pOuterShape,
	ni/.estore in         = \pNIn,
	no/.estore in         = \pNOut,
	nf/.estore in         = \pNFunc,
	f1/.estore in         = \pFuncA,
	f2/.estore in         = \pFuncB,
	f3/.estore in         = \pFuncC,
	f4/.estore in         = \pFuncD,
	reverse/.is toggle,
	reverse shape/.is toggle,
	default/.style = {
		type= ,
		inner shape = noinner, 
		outer shape = transition shape v1v1,
		ni=1, no=1, nf=0, 
		f1=$ f_1 $, 
		f2=$ f_2 $, 
		f3=$ f_3 $, 
		f4=$ f_4 $, 
		reverse = false, 
		reverse shape=false, 
	},
}


\ExplSyntaxOn
% regex function to strip the "|" delimiter between function
% arguments.
\tl_new:N \l_stripdelim_tl
\cs_new:Npn \stripdelim #1 {
  \tl_set:Nn \l_stripdelim_tl {#1}
  \regex_replace_all:nnN { | } { } \l_stripdelim_tl
  \tl_use:N \l_stripdelim_tl
}

\NewDocumentCommand{\makeFunctions}{m m} {%
  \def\dummylbl{\funcStyle\stripdelim{#2}}
  \def\parentName{#1}
  \coordinate (tmpPosOfFunBox) at (0,0);
  \pgfmathtruncatemacro{\countFun}{0};
  % \begin{pgfonlayer}{foreground}
    \drawFunBoxes{ #2 }
  % \end{pgfonlayer}
}
\NewDocumentCommand{\drawFunBoxes}{ >{ \SplitList { | } } m } {
  \ProcessList { #1 } { \davs__tokens_drawfun_rec:n }
}   
\cs_new_protected:Nn \davs__tokens_drawfun_rec:n {
  \pgfmathtruncatemacro{\countFun}{\countFun + 1}
  \node[draw, thin, fill=\defaultfillcolor, anchor=west,
    inner\space sep=2pt] (\parentName\countFun) at (tmpPosOfFunBox)
    {\vphantom{\dummylbl}\funcStyle #1};
  \coordinate[xshift=2pt]
    (tmpPosOfFunBox) at (\parentName\countFun.east);   
}
\ExplSyntaxOff


\endinput